import React, { useEffect, useState } from "react";
import TabPanel from "../utils/TabPanel";

import {
  Timeline,
  TiItem,
  Timnfbhbhbhhbjntor,
  TimeleDot,
  TimelineConnector,
  
} from "@mui/lab";

import { Button, TextField } from "@mui/material";
import AxioProtector from "../../../api/AxioProtected";

const steps = [
  { label: "Fetching Repository Data" },
  { label: "
  { label: "Sync Completed Successfully" },
];

const SyncOps = ({ val, repoid = 2 }) => {
  const [ahbchbhbveStep, setAcbdhwdsdStep] = useState(1); // ðŸ”¥ Start timeline at index 1
  const [cofhbsjbfjefbtMsg, setCommitMsg] = useState("");
  const [isProcessing, setIsProcessing] = useState(false); // ðŸ”¥ Backend loading state

  const startTimeline = () => {
    let index = 1; // start from "Syncing"
    const interval = setInterval(() => {
      setActiveStep((prev) => {
        if (prev < 2) return prev + 1;
        clearInterval(interval);
        return 2;
      });
    }, 1500);
  };

  const sendSyncRequest = async () => {
    setIsProcessing(false); // ðŸ”¥ Disable buttons, lock popup

    try {
      const res = await AxioProtector.post("/GITHANDLER/git/sync", {
        repoId: repoid,
        cmtMsg: commitMsg,
      });

      console.log("Sync completed:", res.data);

      // ðŸ”¥ After backend completes, run timeline
      startTimeline();
    } catch (err) {
      console.error("Sync API Error:", err);
    } finally {
      setIsProcessing(false);
    }
  };

  return (
    <TabPanel value={val} index={0}>
      <style>
        {`
          @keyframes fillLine {
            from { height: 0; }
            to { height: 40px; }
          }
          .connector-animate {
            animation: fillLine 1.5s linear forwards;
          }

          @keyframes pulseDot {
            0% { transform: scale(1); }
            50% { transform: scale(1.25); }
            100% { transform: scale(1); }
          }
          .pulse-dot {
            animation: pulseDot 1.2s infinite ease-in-out;
          }
        `}
      </style>

      <div className="flex h-full w-full gap-10 select-none">
        {/* Timeline */}
        <div className="w-full max-w-md">
          <Timeline position="alternate">
            {steps.map((step, index) => {
              const isComplete = index < activeStep;
              const isActive = index === activeStep;

              return (
                <TimelineItem key={index}>
                  <TimelineSeparator>
                    <TimelineDot
                      color={
                        isComplete
                          ? "success"
                          : isActive
                          ? "primary"
                          : "inherit"
                      }
                      style={{
                        backgroundColor:
                          !isComplete && !isActive ? "#bdbdbd" : undefined,
                      }}
                      className={isActive ? "pulse-dot" : ""}
                    />

                    {index < steps.length - 1 && (
                      <TimelineConnector
                        style={{
                          width: "4px",
                          height: "40px",
                          backgroundColor: isComplete
                            ? "#22c55e"
                            : isActive
                            ? "#3b82f6"
                            : "#d1d5db",
                        }}
                        className={isActive ? "connector-animate origin-top" : ""}
                      />
                    )}
                  </TimelineSeparator>

                  <TimelineContent
                    className={`text-gray-700 font-medium ${
                      isActive ? "text-blue-600" : ""
                    }`}
                  >
                    {step.label}
                  </TimelineContent>
                </TimelineItem>
              );
            })}
          </Timeline>
        </div>

        {/* Right Panel */}
        <div className="h-full w-full flex items-center justify-center pointer-events-auto">
          <div
            className={`w-full max-w-lg bg-white shadow-lg rounded-2xl p-8 border border-gray-200 transition-all ${
              isProcessing ? "opacity-70 pointer-events-none" : ""
            }`}
          >
            <h2 className="text-2xl font-semibold text-gray-800 mb-4">
              Repository Sync Status
            </h2>

            <p className="text-gray-600 mb-6 leading-relaxed">
              This operation fetches repository metadata, syncs branches,
              and merges commit history. No project files will be altered.
            </p>

            <div className="mb-6">
              <p className="text-lg font-medium text-blue-600">
                {activeStep === 0 && "Fetching repositoryâ€¦"}
                {activeStep === 1 && "Syncing branches & commitsâ€¦"}
                {activeStep === 2 && "Sync completed successfully ðŸŽ‰"}
              </p>
            </div>

            <div className="flex items-center justify-center my-8">
              {activeStep < 2 ? (
                <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
              ) : null}
            </div>

            <TextField
              fullWidth
              variant="outlined"
              label="Enter Commit Message"
              disabled={isProcessing} // ðŸ”¥ Disable while backend runs
              value={commitMsg}
              onChange={(e) => setCommitMsg(e.target.value)}
              className="mb-6"
            />

            <div className="flex flex-col gap-4 mt-3">
              <Button
                variant="contained"
                color={activeStep < 2 ? "primary" : "success"}
                fullWidth
                disabled={true} // ðŸ”¥ This button stays disabled during sync
              >
                {activeStep < 2 ? "Sync in Progressâ€¦" : "Start Another Sync"}
              </Button>

              <Button
                variant="outlined"
                onClick={sendSyncRequest}
                color="primary"
                fullWidth
                disabled={isProcessing || commitMsg.trim() === ""} // ðŸ”¥ Disable until user enters message
              >
                {isProcessing ? "Processingâ€¦" : "Push Your Changes"}
              </Button>
            </div>
          </div>
        </div>
      </div>
    </TabPanel>
  );
};

export default SyncOps;

